<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Visualizer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(45deg, #0a0a0a, #1a1a2e, #16213e);
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #visualizer {
            width: 100vw;
            height: 100vh;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.1) 0%, transparent 70%);
            position: relative;
        }

        canvas {
            display: block;
            background: transparent;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-group {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        input[type="file"] {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        select {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px;
            border-radius: 5px;
            margin: 5px;
        }

        .info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255,255,255,0.7);
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="visualizer">
        <canvas id="canvas"></canvas>
        
        <div class="controls">
            <div class="control-group">
                <input type="file" id="audioFile" accept="audio/*,.mp3,.wav,.ogg,.m4a">
                <button id="playBtn" disabled>Play</button>
                <button id="pauseBtn" disabled>Pause</button>
            </div>
            
            <div class="control-group">
                <label style="color: white;">Visualization:</label>
                <select id="visualMode">
                    <option value="bars">Frequency Bars</option>
                    <option value="circle">Circular</option>
                    <option value="waveform">Waveform</option>
                    <option value="particles">Particles</option>
                    <option value="spiral">Spiral</option>
                </select>
            </div>
        </div>

        <div class="info">
            <div>Upload an audio file to start visualizing</div>
            <div>Supported formats: MP3, WAV, OGG, M4A</div>
            <div>Perfect for screen recording for YouTube videos</div>
        </div>
    </div>

    <audio id="audio" style="display: none;"></audio>

    <script>
        class AudioVisualizer {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.audio = document.getElementById('audio');
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.source = null;
                this.animationId = null;
                this.currentFileName = '';
                
                this.particles = [];
                this.visualMode = 'bars';
                
                this.setupCanvas();
                this.setupEventListeners();
                this.setupParticles();
            }
            
            setupCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                });
            }
            
            setupEventListeners() {
                const fileInput = document.getElementById('audioFile');
                const playBtn = document.getElementById('playBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const visualMode = document.getElementById('visualMode');
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.currentFileName = file.name;
                        this.loadAudio(e);
                    }
                });
                playBtn.addEventListener('click', () => this.play());
                pauseBtn.addEventListener('click', () => this.pause());
                visualMode.addEventListener('change', (e) => {
                    this.visualMode = e.target.value;
                    if (this.visualMode === 'particles') {
                        this.setupParticles();
                    }
                });
            }
            
            setupParticles() {
                this.particles = [];
                for (let i = 0; i < 100; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        size: Math.random() * 3 + 1,
                        hue: Math.random() * 360
                    });
                }
            }
            
            loadAudio(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                console.log('Loading file:', file.name, 'Type:', file.type, 'Size:', file.size);
                
                // Clean up previous URL if exists
                if (this.audio.src) {
                    URL.revokeObjectURL(this.audio.src);
                }
                
                // Try multiple approaches for better compatibility
                this.tryLoadAudio(file, 0);
            }
            
            tryLoadAudio(file, attemptNumber) {
                const methods = [
                    () => this.loadWithObjectURL(file),
                    () => this.loadWithDataURL(file),
                    () => this.loadWithArrayBuffer(file)
                ];
                
                if (attemptNumber >= methods.length) {
                    this.showFallbackMessage(file);
                    return;
                }
                
                console.log(`Attempt ${attemptNumber + 1}: Trying loading method ${attemptNumber + 1}`);
                methods[attemptNumber]();
                
                // Set timeout to try next method if this one fails
                setTimeout(() => {
                    if (this.audio.readyState < 2) { // If still not loaded enough
                        console.log(`Method ${attemptNumber + 1} failed, trying next...`);
                        this.tryLoadAudio(file, attemptNumber + 1);
                    }
                }, 3000);
            }
            
            loadWithObjectURL(file) {
                const url = URL.createObjectURL(file);
                this.audio.src = url;
                this.setupAudioEvents();
                this.audio.load();
            }
            
            loadWithDataURL(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.audio.src = e.target.result;
                    this.setupAudioEvents();
                    this.audio.load();
                };
                reader.readAsDataURL(file);
            }
            
            loadWithArrayBuffer(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const arrayBuffer = e.target.result;
                    const blob = new Blob([arrayBuffer], { type: file.type });
                    const url = URL.createObjectURL(blob);
                    this.audio.src = url;
                    this.setupAudioEvents();
                    this.audio.load();
                };
                reader.readAsArrayBuffer(file);
            }
            
            setupAudioEvents() {
                // Remove old event listeners
                this.audio.onloadstart = null;
                this.audio.onloadeddata = null;
                this.audio.oncanplay = null;
                this.audio.onloadedmetadata = null;
                this.audio.onerror = null;
                this.audio.oncanplaythrough = null;
                
                this.audio.onloadstart = () => console.log('Load started');
                this.audio.onloadeddata = () => console.log('Data loaded');
                this.audio.oncanplay = () => console.log('Can start playing');
                
                this.audio.onloadedmetadata = () => {
                    console.log('Audio metadata loaded successfully');
                    console.log('Duration:', this.audio.duration);
                    console.log('Ready state:', this.audio.readyState);
                    
                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = false;
                    
                    // Update info display
                    document.querySelector('.info').innerHTML = `
                        <div style="color: #00ff88;">✓ Audio loaded: ${this.currentFileName}</div>
                        <div>Duration: ${Math.floor(this.audio.duration / 60)}:${Math.floor(this.audio.duration % 60).toString().padStart(2, '0')}</div>
                        <div>Click Play to start visualization</div>
                    `;
                };
                
                this.audio.onerror = (e) => {
                    console.error('Audio loading error details:', {
                        error: e,
                        audioError: this.audio.error,
                        networkState: this.audio.networkState,
                        readyState: this.audio.readyState
                    });
                    
                    let errorMsg = 'Unknown error';
                    if (this.audio.error) {
                        switch(this.audio.error.code) {
                            case 1: errorMsg = 'MEDIA_ERR_ABORTED - Loading was aborted'; break;
                            case 2: errorMsg = 'MEDIA_ERR_NETWORK - Network error'; break; 
                            case 3: errorMsg = 'MEDIA_ERR_DECODE - Decoding error'; break;
                            case 4: errorMsg = 'MEDIA_ERR_SRC_NOT_SUPPORTED - Format not supported'; break;
                        }
                    }
                    
                    console.error('Specific error:', errorMsg);
                };
                
                this.audio.oncanplaythrough = () => {
                    console.log('Audio can play through - ready for visualization');
                };
            }
            
            showFallbackMessage(file) {
                console.log('All loading methods failed, showing fallback options');
                document.querySelector('.info').innerHTML = `
                    <div style="color: #ff6b6b;">⚠ Audio format not supported</div>
                    <div>File: ${file.name}</div>
                    <div style="margin-top: 10px;">Solutions:</div>
                    <div>1. Convert to standard MP3 (44.1kHz, 128-320kbps)</div>
                    <div>2. Try WAV format instead</div>
                    <div>3. Use online converter like CloudConvert</div>
                `;
                
                // Show a demo visualization anyway
                this.startDemoVisualization();
            }
            
            startDemoVisualization() {
                console.log('Starting demo visualization');
                // Create fake audio data for demo
                this.dataArray = new Uint8Array(256);
                
                const animate = () => {
                    this.animationId = requestAnimationFrame(animate);
                    
                    // Generate fake frequency data
                    const time = Date.now() * 0.001;
                    for (let i = 0; i < this.dataArray.length; i++) {
                        this.dataArray[i] = Math.abs(Math.sin(time + i * 0.1) * 128 + Math.sin(time * 2 + i * 0.05) * 64);
                    }
                    
                    this.draw();
                };
                animate();
            }
            
            async play() {
                try {
                    // Initialize audio context on first play (required by browsers)
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.analyser = this.audioContext.createAnalyser();
                        this.analyser.fftSize = 512;
                        this.analyser.smoothingTimeConstant = 0.8;
                        this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                        
                        this.source = this.audioContext.createMediaElementSource(this.audio);
                        this.source.connect(this.analyser);
                        this.analyser.connect(this.audioContext.destination);
                        
                        console.log('Audio context initialized');
                    }
                    
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                        console.log('Audio context resumed');
                    }
                    
                    await this.audio.play();
                    console.log('Audio playing');
                    this.startVisualization();
                    
                } catch (error) {
                    console.error('Error playing audio:', error);
                    alert('Error playing audio. Please try again or use a different file.');
                }
            }
            
            pause() {
                this.audio.pause();
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
            }
            
            startVisualization() {
                console.log('Starting visualization');
                const animate = () => {
                    if (this.audio.paused) return; // Stop if audio is paused
                    
                    this.animationId = requestAnimationFrame(animate);
                    
                    if (this.analyser && this.dataArray) {
                        this.analyser.getByteFrequencyData(this.dataArray);
                        this.draw();
                    }
                };
                animate();
            }
            
            draw() {
                // Clear canvas with slight trail effect
                this.ctx.fillStyle = 'rgba(10, 10, 10, 0.2)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Check if we have valid data
                if (!this.dataArray || this.dataArray.every(val => val === 0)) {
                    // Show a default animation if no audio data
                    this.drawDefaultAnimation();
                    return;
                }
                
                switch (this.visualMode) {
                    case 'bars': this.drawBars(); break;
                    case 'circle': this.drawCircle(); break;
                    case 'waveform': this.drawWaveform(); break;
                    case 'particles': this.drawParticles(); break;
                    case 'spiral': this.drawSpiral(); break;
                }
            }
            
            drawDefaultAnimation() {
                // Simple pulsing circle when no audio is detected
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const time = Date.now() * 0.005;
                const radius = 50 + Math.sin(time) * 20;
                
                this.ctx.strokeStyle = `hsl(${time * 50 % 360}, 70%, 60%)`;
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                this.ctx.stroke();
                
                // Add text
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                this.ctx.font = '20px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('Loading audio data...', centerX, centerY + 100);
            }
            
            drawBars() {
                const barWidth = this.canvas.width / this.dataArray.length;
                let x = 0;
                
                for (let i = 0; i < this.dataArray.length; i++) {
                    const barHeight = (this.dataArray[i] / 255) * this.canvas.height * 0.8;
                    
                    const hue = (i / this.dataArray.length) * 360;
                    const saturation = 70 + (this.dataArray[i] / 255) * 30;
                    const lightness = 50 + (this.dataArray[i] / 255) * 30;
                    
                    this.ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth - 2, barHeight);
                    
                    // Mirror effect
                    this.ctx.fillStyle = `hsla(${hue}, ${saturation}%, ${lightness}%, 0.3)`;
                    this.ctx.fillRect(x, 0, barWidth - 2, barHeight * 0.5);
                    
                    x += barWidth;
                }
            }
            
            drawCircle() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const radius = 100;
                
                for (let i = 0; i < this.dataArray.length; i++) {
                    const angle = (i / this.dataArray.length) * Math.PI * 2;
                    const amplitude = (this.dataArray[i] / 255) * 200;
                    
                    const x1 = centerX + Math.cos(angle) * radius;
                    const y1 = centerY + Math.sin(angle) * radius;
                    const x2 = centerX + Math.cos(angle) * (radius + amplitude);
                    const y2 = centerY + Math.sin(angle) * (radius + amplitude);
                    
                    const hue = (i / this.dataArray.length) * 360;
                    this.ctx.strokeStyle = `hsl(${hue}, 80%, 60%)`;
                    this.ctx.lineWidth = 3;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x1, y1);
                    this.ctx.lineTo(x2, y2);
                    this.ctx.stroke();
                }
            }
            
            drawWaveform() {
                this.ctx.strokeStyle = '#00ff88';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                
                const sliceWidth = this.canvas.width / this.dataArray.length;
                let x = 0;
                
                for (let i = 0; i < this.dataArray.length; i++) {
                    const v = this.dataArray[i] / 128;
                    const y = v * this.canvas.height / 2;
                    
                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                    
                    x += sliceWidth;
                }
                
                this.ctx.stroke();
            }
            
            drawParticles() {
                const avgFreq = this.dataArray.reduce((a, b) => a + b) / this.dataArray.length;
                
                this.particles.forEach((particle, index) => {
                    const freqData = this.dataArray[index % this.dataArray.length];
                    const intensity = freqData / 255;
                    
                    particle.x += particle.vx * (1 + intensity);
                    particle.y += particle.vy * (1 + intensity);
                    particle.size = 1 + intensity * 5;
                    
                    if (particle.x < 0 || particle.x > this.canvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > this.canvas.height) particle.vy *= -1;
                    
                    this.ctx.fillStyle = `hsla(${particle.hue + avgFreq}, 80%, 60%, ${intensity})`;
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
            }
            
            drawSpiral() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                this.ctx.strokeStyle = '#ff6b6b';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                
                for (let i = 0; i < this.dataArray.length; i++) {
                    const angle = (i / this.dataArray.length) * Math.PI * 8;
                    const amplitude = (this.dataArray[i] / 255) * 3;
                    const radius = i * 2 + amplitude * 50;
                    
                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;
                    
                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                }
                
                this.ctx.stroke();
            }
        }
        
        // Initialize the visualizer
        const visualizer = new AudioVisualizer();
    </script>
</body>
</html>